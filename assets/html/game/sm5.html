{% extends "base.html" %}
{% block title %}SM5 game on {{ game.start_time.strftime("%A, %B %d at %I:%M %p") }}{% endblock %}


{% block html_head %}

<link rel="stylesheet" href="/assets/css/game/sm5.css">

<script>
    function onReady() {
        row = 3;
        {% if game.ranked %}
            row = 4;
        {% endif %}
    }

    document.addEventListener("DOMContentLoaded", onReady);
</script>

{% endblock %}


{% block content %}

<div style="text-align: center;">
    <div style="margin-left: 2rem; margin-right: 2rem; text-align: center;">
        <span title="Game Date"><h2 style="font-size: 25px;">Game on {{ game.get_timestamp()}}</h2></span>

        <form method="post" action="/matchmaking" class="inline">
            <input type="hidden" name="mode" value="sm5">
            {% for player in players_matchmake_team1 %}
                <input type="hidden" name="1player{{ loop.index }}" value="{{ player }}">
            {% endfor %}
            {% for player in players_matchmake_team2 %}
                <input type="hidden" name="2player{{ loop.index }}" value="{{ player }}">
            {% endfor %}
            <button type="submit" class="link-button">
                <span title="Matchmake"><h3><a>Rematchmake</a></h3></span>
            </button>
        </form>
        {% if is_admin %}<span title="Admin Page"><h3><a href="/admin/game/sm5/{{ game.id }}/">Admin Page</a></h3></span>{% endif %}
        <span><h3><a href="/api/game/sm5/{{ game.id }}/tdf">Game File</a></h3></span>
        <span title="Replay"><h3><a href="/game/sm5/{{ game.id }}/replay">Replay</a></h3></span>
    </div>
    <div class="userlist" style="text-align: left;">
        <div id="teams">
            {% for team in teams %}
                <div id="{{ team.color }}_team" class="team">
                    <h2 style="font-size: 20px;" class="team_score {{ team.css_class }}">{{ team.element }} Team: {{ team.score }}{{team.score_adjustment_string}}</h2>

                    <div class="outer-scrolling-table">
                        <div class="inner-scrolling-table">
                            <table id="{{ team.color }}_table">
                                <th class="role fixed-column" {{ tooltip("sm5_role") }}><p>Role</p></th>
                                <th class="second-fixed-column" {{ tooltip("sm5_codename") }}><p>Codename</p></th>
                                {% if game.ranked %}
                                    <th {{ tooltip("sm5_rating") }}><p>Rating</p></th>
                                    <th {{ tooltip("sm5_rating_difference") }}><p>Rating Diff</p></th>
                                {% endif %}
                                <th {{ tooltip("sm5_score") }}><p>Score</p></th>
                                <th {{ tooltip("sm5_positive_score") }}><p>Positive Score</p></th>
                                <th {{ tooltip("sm5_points_minute") }}><p>PPM</p></th>
                                <th {{ tooltip("sm5_lives_left") }}><p>Lives Left</p></th>
                                <th {{ tooltip("sm5_alive") }}><p>Alive</p></th>
                                <th {{ tooltip("sm5_shots_left") }}><p>Shots Left</p></th>
                                <th {{ tooltip("sm5_accuracy") }}><p>Accuracy</p></th>
                                <th {{ tooltip("sm5_kd_ratio") }}><p>K/D Ratio</p></th>
                                <th {{ tooltip("sm5_states") }}><p>States</p></th>
                                <th {{ tooltip("sm5_missiled_other") }}><p>Missiled Other</p></th>
                                <th {{ tooltip("sm5_missiled") }}><p>Missiled</p></th>
                                <th {{ tooltip("sm5_shot_team") }}><p>Shot Team</p></th>
                                <th {{ tooltip("sm5_medic_hits") }}><p>Medic Hits</p></th>
                                <th {{ tooltip("sm5_mvp_points") }}><a href="https://lfstats.com/pages/aboutSM5#:~:text=Lose%203%20lives-,MVP%20Points,-All%20Players" target="_blank"><p>MVP Points</p></a></th>
                                {% for player in team.players_with_sum %}

                                    <tr class="{{ player.css_class }}">
                                        <td class="role fixed-column" style="width: 30px"><p>{{ sm5_role_icon(player) }}</p></td>
                                        <td class="second-fixed-column">{{ player_with_penalties(player) }}</td>
                                        {% if game.ranked %}
                                            {% if player.entity_end and player.entity_end.current_rating_mu %}
                                                <td title= "mu: {{ player.entity_end.current_rating_mu|round(2) }}, sigma: {{ player.entity_end.current_rating_sigma|round(2)}}">
                                                    {{ (player.entity_end.current_rating_mu - 3 * player.entity_end.current_rating_sigma)|round(2) }}
                                                </td>
                                                <td title="mu: {{ player.entity_end.rating_difference_mu|round(2) }}, sigma: {{ player.entity_end.rating_difference_sigma|round(2)}}"
                                                class="{% if player.entity_end.rating_difference < 0 %}fire-team{% elif player.entity_end.rating_difference > 0 %}earth-team{% endif %}">
                                                    {% if player.entity_end.rating_difference > 0 %}+{% endif %}{{ player.entity_end.rating_difference|round(2) }}
                                                </td>
                                            {% else %}
                                                <td></td>
                                                <td></td>
                                            {% endif %}
                                        {% endif %}
                                        {% if player.player_info.is_member %}
                                            <td title="Scorecard"><a href="/game/sm5/{{game.id}}/scorecard/{{player.entity_end.id}}">{{ player.score }}</a></td>
                                        {% else %}
                                            <td>{{ player.score }}</td>
                                        {% endif %}
                                        <td><p>{{ player.get_gross_positive_score() }}</p></td>
                                        <td><p>{{ player.points_per_minute }}</p></td>
                                        <td><p>{{ player.lives_left }}</p></td>
                                        <td class="scorecard_player_stat" {{ tooltip("sm5_alive") }}>
                                        {% if player.entity_end %}
                                        <div style="display: flex">
                                            <div class="mini-chart">
                                                <canvas id="time_in_game_{{player.entity_end.id}}"></canvas>
                                            </div>
                                            <span style="margin: auto">{{ player.time_in_game_str }}</span>
                                        </div>
                                        {% endif %}
                                        </td>
                                        <td><p>{{ player.shots_left }}</p></td>
                                        <td title="{{player.shots_hit}}/{{player.shots_fired}}"><p>{{ player.accuracy_str }}</p></td>
                                        <td title="{{player.shot_opponent}}/{{player.times_zapped}}"><p>{{ player.kd_ratio_str }}</p></td>
                                        <td class="scorecard_player_stat" {{ tooltip("sm5_states") }}>
                                        {% if player.entity_end %}
                                            <div class="mini-chart" style="margin: auto">
                                                <canvas id="uptime_{{player.entity_end.id}}"></canvas>
                                            </div>
                                        {% endif %}
                                        </td>
                                        <td><p>{{ player.missiled_opponent }}</p></td>
                                        <td><p>{{ player.times_missiled }}</p></td>
                                        <td><p>{{ player.shot_team }}</p></td>
                                        <td><p>{{ player.medic_hits_str }}</p></td>
                                        <td><p>{{ "%.2f" % (player.mvp_points | round(2)) }}</p></td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div id="stats">
            <div class="score-chart">
                <canvas id="score_chart"></canvas>
            </div>
            <div class="lives-chart" >
                <canvas id="lives_chart" style="clear: both;"></canvas>
            </div>
            <div class="notable-style-picker">
                <label for="change_notable">Show events</label>
                <select id="change_notable" name="notable_annotations" onchange="toggleNotableEvents(this.value);">
                    <option value="none">None</option>
                    <option value="short" selected>Short</option>
                    <option value="verbose">Verbose</option>
                </select>
            </div>
            {% if game.ranked and win_chance_before_game and win_chance_after_game %}
            <div class="win-chances">
                <div class="win-chance-before-game">
                    <canvas id="win_chance_before_game" style="clear: both;"></canvas>
                </div>
                <div class="win-chance">
                    <canvas id="win_chance" style="clear: both;"></canvas>
                </div>
            </div>
            {% endif %}
        </div>

        <div style="clear: both;"></div>

        <h1 class="desktop_notif">For more detailed stats, please view the website on desktop.</h1>
    </div>
</div>


<script>
    const scoreChart = new Chart("score_chart", {
        type: "line",
        data: {
            labels: {{score_chart_labels}},
            datasets: [
            {% for team in teams %}
            {
                label: "{{ team.element }} Team Score",
                data: {{score_chart_data[team.team]}},
                borderColor: "{{ team.css_color_name }}",
                backgroundColor: "{{ team.css_color_name }}",
                fill: false,
                tension: 0.4,
                pointRadius: 0,
                pointHitRadius: 10
            }{{ "," if not loop.last }}
            {% endfor %}
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            notableEventStyle: "short",
            plugins: {
                {{ notable_events_annotation(notable_events) }},
                tooltip: {
                    callbacks: {
                        title: tooltip_minute_to_mmss
                    }
                },
                // change label colors to white
                legend: {
                    labels: {
                        color: "white"
                    }
                },
                title: {
                    display: true,
                    text: "Score Over Time",
                    color: "white",
                    font: {
                        size: 24
                    }
                }
            },
            scales: {
                x: {
                    type: "linear",
                    ticks: {
                        color: "white",
                        callback: tick_minute_to_mmss
                    },
                    title: {
                        display: true,
                        text: "Time",
                        color: "white"
                    }
                },
                y: {
                    type: "linear",
                    ticks: {
                        color: "white",
                    },
                    title: {
                        display: true,
                        text: "Score",
                        color: "white"
                    }
                }
            }
        }
    });

    const livesChart = new Chart("lives_chart", {
        type: "line",
        data: {
            labels: {{score_chart_labels}},
            datasets: [
            {% for chart in lives_over_time %}
            {
                label: "{{ chart.label }}",
                data: {{ chart.data }},
                borderColor: "{{ chart.color }}",
                backgroundColor: "{{ chart.color }}",
                fill: false,
                tension: 0.4,
                pointRadius: 0,
                pointHitRadius: 10
            }{{ "," if not loop.last }}
            {% endfor %}
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            notableEventStyle: "short",
            plugins: {
                {{ notable_events_annotation(notable_events) }},
                tooltip: {
                    callbacks: {
                        title: function(tooltipItem) {
                            // show formatted time
                            var time = this.chart.data.labels[tooltipItem[0].dataIndex];

                            if (time.toString().endsWith(".5")) {
                                return time.toString().slice(0, -2) + ":30";
                            } else {
                                return time + ":00";
                            }
                        },
                    }
                },
                // change label colors to white
                legend: {
                    labels: {
                        color: "white"
                    }
                },
                title: {
                    display: true,
                    text: "Average Lives Over Time",
                    color: "white",
                    font: {
                        size: 24
                    }
                }
            },
            scales: {
                x: {
                    type: "linear",
                    ticks: {
                        color: "white",
                        callback: tick_minute_to_mmss
                    },
                    title: {
                        display: true,
                        text: "Time",
                        color: "white"
                    }
                },
                y: {
                    type: "linear",
                    ticks: {
                        color: "white",
                    },
                    title: {
                        display: true,
                        text: "Score",
                        color: "white",
                    }
                }
            }
        }
    });

    {% if game.ranked %}
    new Chart("win_chance_before_game", {
        type: "pie",
        data: {
            labels: ["{{ teams[0].element }}", "{{ teams[1].element }}"],
            datasets: [{
                backgroundColor: ["{{ teams[0].css_color_name }}", "{{ teams[1].css_color_name }}"],
                data: [{{ (win_chance_before_game[0]*100)|round(2) }}, {{ (win_chance_before_game[1]*100)|round(2) }}]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false,
                    fullSize: false
                },
                title: {
                    display: true,
                    text: "Predicted Win Chance",
                    color: "white",
                    font: {
                        size: 24
                    }
                }
            }
        }
    });

    new Chart("win_chance", {
        type: "pie",
        data: {
            labels: ["{{ teams[0].element }}", "{{ teams[1].element }}"],
            datasets: [{
                backgroundColor: ["{{ teams[0].css_color_name }}", "{{ teams[1].css_color_name }}"],
                data: [{{ (win_chance_after_game[0]*100)|round(2) }}, {{ (win_chance_after_game[1]*100)|round(2) }}]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false,
                    fullSize: false
                },
                title: {
                    display: true,
                    text: "Actual Win Chance",
                    color: "white",
                    font: {
                        size: 24
                    }
                }
            }
        }
    });
    {% endif %}

    {% for team in teams %}
            {% for player in team.players %}
                {{ uptime_chart(player.entity_end.id, player.state_distribution_pie_chart) }}
                {{ alive_time_chart(player) }}
         {% endfor %}
    {% endfor %}

    function toggleAnnotations(chart, annotationStyle) {
        chart.options.notableEventStyle = annotationStyle;
        const annotations = chart.options.plugins.annotation.annotations;
        const isVisible = annotationStyle != "none";

        if (annotations && typeof annotations === "object") {
            const firstAnnotationKey = Object.keys(annotations)[0];
            if (firstAnnotationKey) {
                for (const key of Object.keys(annotations)) {
                    annotations[key].display = isVisible;
                }

                chart.update();
            }
        }
    }

    function toggleNotableEvents(annotationStyle) {
        toggleAnnotations(livesChart, annotationStyle);
        toggleAnnotations(scoreChart, annotationStyle);
    }

</script>

</body>

{% endblock %}